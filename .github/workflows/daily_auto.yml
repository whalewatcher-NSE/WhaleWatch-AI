name: "ğŸ‹ Daily Dashboard Pipeline"

on:
  schedule:
    - cron: "30 13 * * 1-5" # 7:00 PM IST
    - cron: "30 14 * * 1-5" # 8:00 PM IST (Retry)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-pipeline:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: ğŸ“¦ Install dependencies
        run: pip install -r requirements.txt

      - name: ğŸ“¥ Step 1 - Fetch Daily Data
        run: |
          for attempt in 1 2 3; do
            echo "--- Attempt $attempt ---"
            python src/data_loader.py
            if [ $? -eq 0 ]; then break; fi
            if [ $attempt -lt 3 ]; then sleep 600; fi
          done

      - name: ğŸ§  Step 2 - Compute Conviction Scores
        run: python src/feature_engine.py

      - name: ğŸ’¾ Step 3 - Commit to Repo
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ“ˆ Daily Pipeline: Scrape & Score"
          file_pattern: "data/** results/**"
          branch: main
